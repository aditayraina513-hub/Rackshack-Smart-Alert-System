<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rackshack - Mahila Suraksha Alert</title>
    <!-- Tailwind CSS CDN for mobile-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .main-container {
            width: 100%;
            max-width: 420px; /* Mobile width constraint */
            padding: 1rem;
            box-sizing: border-box;
        }
        .alert-button {
            width: 100%;
            height: 300px;
            font-size: 2.5rem;
            font-weight: 900;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 10px 20px rgba(255, 0, 0, 0.4);
            animation: pulse 2s infinite;
        }
        .alert-button:active {
            transform: scale(0.98);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .active-alert-status {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .map-frame {
            height: 250px;
            border-radius: 12px;
            border: 2px solid #ccc;
        }
    </style>
</head>
<body>

<div class="main-container bg-white rounded-xl shadow-2xl p-6">
    <h1 class="text-3xl font-bold text-center text-red-600 mb-2">Rackshack - Suraksha Alert</h1>
    <p class="text-center text-sm text-gray-500 mb-6">Mahila Suraksha Smart Alert System Prototype</p>

    <!-- Emergency Alert Section -->
    <div id="alertSection">
        <button id="emergencyButton"
            class="alert-button bg-red-600 text-white rounded-full hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300">
            EMERGENCY ALERT
            <div class="text-base font-normal mt-2">Dabaayein aur Hold Karein (3 seconds)</div>
        </button>
    </div>

    <!-- Alert Status & Deactivation Section (Hidden by default) -->
    <div id="statusSection" class="hidden mt-6 p-4 bg-red-50 rounded-lg border-2 border-red-300">
        <p class="text-lg font-bold text-red-600 active-alert-status text-center mb-4">
            ALERT ACTIVE! Contacts Ko Notify Kar Diya Gaya Hai
        </p>

        <h2 class="text-xl font-semibold text-gray-800 mb-2">Real-time Location</h2>
        <!-- Location Map Simulation (Placeholder) -->
        <div id="mapContainer" class="map-frame mb-4 overflow-hidden">
            <iframe id="mapFrame" class="w-full h-full" loading="lazy"></iframe>
        </div>

        <button id="deactivateButton"
            class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400">
            STOP ALERT / Main Surakshit Hoon
        </button>
    </div>

    <!-- Message Box for Alerts (Instead of alert()) -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="messageTitle" class="text-xl font-bold mb-2 text-gray-800">Sandesh</h3>
            <p id="messageText" class="text-gray-600 mb-4">Yeh ek prototype sandesh hai.</p>
            <button id="closeMessageBox" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">OK</button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let isAlertActive = false;
    let pressTimer;
    let locationInterval;
    const PRESS_DURATION = 3000; // 3 seconds hold

    // DOM Elements
    const emergencyButton = document.getElementById('emergencyButton');
    const deactivateButton = document.getElementById('deactivateButton');
    const alertSection = document.getElementById('alertSection');
    const statusSection = document.getElementById('statusSection');
    const mapFrame = document.getElementById('mapFrame');
    const messageBox = document.getElementById('messageBox');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const closeMessageBox = document.getElementById('closeMessageBox');

    // --- Utility Functions ---

    // Custom function to display messages instead of alert()
    function showMessage(title, text) {
        messageTitle.textContent = title;
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
        messageBox.classList.add('flex');
    }

    // --- Location Tracking Functions ---

    function getAndDisplayLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                // Simulate sending data to the server (as described in TDD)
                console.log(Sending Real-time Location to Server: Lat=${lat}, Lon=${lon});

                // Display location on the map using a Google Maps embed URL
                // Note: The key parameter is a placeholder and should be removed if embedding requires one.
                const mapUrl = https://maps.google.com/maps?q=${lat},${lon}&hl=en&z=14&output=embed;
                mapFrame.src = mapUrl;

            }, error => {
                console.error("Geolocation Error:", error.message);
                // Fallback location for demo purposes if permission is denied
                const lat = 28.7041; 
                const lon = 77.1025; 
                const mapUrl = https://maps.google.com/maps?q=${lat},${lon}&hl=en&z=14&output=embed;
                mapFrame.src = mapUrl;
                
                if (isAlertActive) {
                   showMessage("Error", "Location access denied. Using last known location.");
                }

            }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
        } else {
            showMessage("Error", "Geolocation is not supported by this device.");
        }
    }

    // --- Alert Management ---

    function activateAlert() {
        isAlertActive = true;
        alertSection.classList.add('hidden');
        statusSection.classList.remove('hidden');
        
        showMessage("ALERT ACTIVE", "Emergency Alert shuru ho gaya hai. Trusted contacts ko aapki live location bhej di gayi hai.");

        // Start location tracking every 10 seconds
        getAndDisplayLocation(); // Get initial location immediately
        locationInterval = setInterval(getAndDisplayLocation, 10000); // Update every 10 seconds

        // Simulate notification dispatch to backend
        console.log("Backend API Call: POST /alert/activate initiated.");
        
        // Disable screen rotation/sleep (conceptual feature)
        // No actual code for this due to browser restrictions, but it's part of the concept.
    }

    function deactivateAlert() {
        if (!isAlertActive) return;

        isAlertActive = false;
        clearInterval(locationInterval);
        
        alertSection.classList.remove('hidden');
        statusSection.classList.add('hidden');

        showMessage("ALERT STOPPED", "Aapne alert band kar diya hai. Sabhi contacts ko aapke surakshit hone ki notification mil gayi hai.");

        // Simulate alert deactivation to backend
        console.log("Backend API Call: POST /alert/deactivate initiated.");
    }


    // --- Event Listeners for Touch/Click ---

    // Touch/Mouse Down Event (Start Timer)
    const startPress = () => {
        // Prevent accidental clicks causing alert
        if (isAlertActive) return; 

        // Change button style to indicate active press
        emergencyButton.style.backgroundColor = '#831e1e'; 
        
        pressTimer = setTimeout(() => {
            // Timer expired, alert is activated
            if (!isAlertActive) {
                activateAlert();
            }
        }, PRESS_DURATION);
    };

    // Touch/Mouse Up Event (Clear Timer)
    const endPress = () => {
        clearTimeout(pressTimer);
        // Reset button style if alert wasn't activated
        if (!isAlertActive) {
             emergencyButton.style.backgroundColor = '#dc2626';
        }
    };

    // Deactivate Button Click
    deactivateButton.addEventListener('click', deactivateAlert);
    
    // Close Message Box
    closeMessageBox.addEventListener('click', () => {
        messageBox.classList.remove('flex');
        messageBox.classList.add('hidden');
    });

    // Attach both mouse and touch events for mobile compatibility
    emergencyButton.addEventListener('mousedown', startPress);
    emergencyButton.addEventListener('touchstart', startPress);
    
    emergencyButton.addEventListener('mouseup', endPress);
    emergencyButton.addEventListener('touchend', endPress);
    emergencyButton.addEventListener('mouseleave', endPress); // To stop timer if mouse slides off

    // Initial load: show the main button
    window.onload = function() {
        // Set default map location if alert is not active
        if (!isAlertActive) {
            mapFrame.src = 'https://maps.google.com/maps?q=28.6139,77.2090&hl=en&z=10&output=embed';
        }
    }

</script>
</body>
</html>